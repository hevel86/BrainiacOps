apiVersion: batch/v1
kind: CronJob
metadata:
  name: remove-node-lb-exclusion
  namespace: kube-system
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: node-label-remover
        spec:
          serviceAccountName: node-label-remover
          restartPolicy: OnFailure
          containers:
            - name: remove-label
              image: bitnami/kubectl:1.34.1
              command:
                - /bin/sh
                - -c
                - |
                  echo "Checking nodes for exclude-from-external-load-balancers label..."
                  for node in $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}'); do
                    if kubectl get node "$node" -o jsonpath='{.metadata.labels.node\.kubernetes\.io/exclude-from-external-load-balancers}' 2>/dev/null | grep -q .; then
                      echo "Removing label from node: $node"
                      kubectl label node "$node" node.kubernetes.io/exclude-from-external-load-balancers- || true
                    else
                      echo "Node $node: label not present (OK)"
                    fi
                  done
                  echo "Done."
