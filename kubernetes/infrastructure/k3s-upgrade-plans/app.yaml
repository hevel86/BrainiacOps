# kubernetes/infrastructure/k3s-upgrade-plans/app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k3s-upgrade-plans
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/hevel86/BrainiacOps
    targetRevision: HEAD
    path: kubernetes/infrastructure/k3s-upgrade-plans
  destination:
    server: https://kubernetes.default.svc
    namespace: cattle-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
---
# kubernetes/infrastructure/k3s-upgrade-plans/plans.yaml
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: k3s-server
  namespace: cattle-system
spec:
  # Only upgrade one control-plane node at a time
  concurrency: 1
  # Opt-in switch: nothing happens until you label a node
  nodeSelector:
    matchExpressions:
      - key: upgrade.k3s.io/enabled
        operator: In
        values: ["true"]
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
  serviceAccountName: system-upgrade
  cordon: true
  drain:
    force: true
    skipWaitForDeleteTimeout: 60
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
  # Use a channel so you can move between stable/testing with a one-line change
  channel: "https://update.k3s.io/v1-release/channels/stable"
  upgrade:
    image: rancher/k3s-upgrade
    args: ["server"]
---
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: k3s-agent
  namespace: cattle-system
spec:
  concurrency: 1
  nodeSelector:
    matchExpressions:
      - key: upgrade.k3s.io/enabled
        operator: In
        values: ["true"]
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  serviceAccountName: system-upgrade
  cordon: true
  drain:
    force: true
    skipWaitForDeleteTimeout: 60
  channel: "https://update.k3s.io/v1-release/channels/stable"
  upgrade:
    image: rancher/k3s-upgrade
    args: ["agent"]
