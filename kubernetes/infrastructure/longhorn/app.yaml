# kubernetes/infrastructure/longhorn/app.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: longhorn
  namespace: argocd
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: longhorn-system
  source:
    repoURL: https://charts.longhorn.io
    chart: longhorn
    targetRevision: 1.*
    helm:
      values: |
        preUpgradeChecker:
          jobEnabled: false
        defaultSettings:
          defaultReplicaCount: 3
          createDefaultDiskLabeledNodes: true
        persistence:
          defaultClass: false
        # This section configures your specific nodes and disks
        longhorn:
          nodes:
            cyborg: # VM with the temporary 1.86TB USB SSD
              disks:
                disk-1:
                  path: "/mnt/longhorn-storage"
                  allowScheduling: true
                  storageReserved: 186000 # Reserving ~186GB
                  tags:
                    - "usb-ssd"
                    - "temp-disk"
            kube2: # VM with the 2TB NVMe
              disks:
                disk-1:
                  path: "/mnt/longhorn-storage"
                  allowScheduling: true
                  storageReserved: 204800 # Reserving 200GB
                  tags:
                    - "nvme"
            brainiac: # Bare-metal node with the 2TB SSD
              disks:
                disk-1:
                  path: "/mnt/longhorn-storage"
                  allowScheduling: true
                  storageReserved: 204800 # Reserving 200GB
                  tags:
                    - "ssd"
  syncPolicy:
    automated:
      selfHeal: true
      prune: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
      - Replace=true