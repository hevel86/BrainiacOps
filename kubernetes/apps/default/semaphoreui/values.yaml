# kubernetes/apps/default/semaphoreui/values.yaml
fullnameOverride: semaphoreui

image:
  tag: v2.16.37

service:
  type: LoadBalancer
  annotations:
    metallb.universe.tf/loadBalancerIPs: 10.0.0.221

persistence:
  existingClaim: semaphoreui-data-lh

database:
  type: bolt
  path: /var/lib/semaphore/database.boltdb
  persistence:
    existingClaim: semaphoreui-data-lh

envFromSecrets:
  - semaphoreui-secrets

extraEnvVariables:
  TZ: America/New_York

extraEnvSecrets:
  SEMAPHORE_ACCESS_KEY_ENCRYPTION:
    secret: semaphoreui-secrets
    key: SEMAPHORE_ACCESS_KEY_ENCRYPTION

extraInitContainers:
  - name: init-admin-password
    image: semaphoreui/semaphore:v2.16.37
    imagePullPolicy: IfNotPresent
    command:
      - sh
      - -c
      - |
        set -euo pipefail
        CONFIG_PATH="${SEMAPHORE_CONFIG_PATH}"
        if [ -d "${CONFIG_PATH}" ]; then
          CONFIG_PATH="${CONFIG_PATH%/}/config.json"
        fi
        if [ ! -f "${CONFIG_PATH}" ]; then
          echo "Config file ${CONFIG_PATH} not found; skipping password sync on this boot"
          exit 0
        fi
        echo "Ensuring admin user ${SEMAPHORE_ADMIN} exists in Semaphore"
        if semaphore --config "${CONFIG_PATH}" user get --login "${SEMAPHORE_ADMIN}" >/dev/null 2>&1; then
          semaphore --config "${CONFIG_PATH}" user change-by-login --login "${SEMAPHORE_ADMIN}" --password "${SEMAPHORE_ADMIN_PASSWORD}"
          exit 0
        fi
        semaphore --config "${CONFIG_PATH}" user add \
          --admin \
          --login "${SEMAPHORE_ADMIN}" \
          --name "${SEMAPHORE_ADMIN_NAME}" \
          --email "${SEMAPHORE_ADMIN_EMAIL}" \
          --password "${SEMAPHORE_ADMIN_PASSWORD}"
    env:
      - name: SEMAPHORE_CONFIG_PATH
        value: /etc/semaphore/config.json
      - name: SEMAPHORE_ADMIN
        value: admin
      - name: SEMAPHORE_ADMIN_NAME
        value: Cluster Admin
      - name: SEMAPHORE_ADMIN_EMAIL
        value: admin@example.com
    envFrom:
      - secretRef:
          name: semaphoreui-secrets
    volumeMounts:
      - name: config
        mountPath: /etc/semaphore/config.json
        subPath: config.json
      - name: boltdb
        mountPath: /var/lib/semaphore
      - name: workdir
        mountPath: /tmp/semaphore
