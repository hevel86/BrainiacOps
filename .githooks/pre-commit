#!/bin/bash

echo "üîç Running TruffleHog scan on staged changes..."

# Create a temporary index for only staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.ya?ml$|\.env$|\.json$')

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No staged YAML, ENV, or JSON files to scan."
    exit 0
fi

# Run TruffleHog only on staged changes using git diff and pipe to stdin
git diff --cached | docker run --rm -i ghcr.io/trufflesecurity/trufflehog:latest \
  filesystem --path - --only-verified --no-update \
  --fail

EXIT_CODE=$?

if [ "$EXIT_CODE" -ne 0 ]; then
    echo "‚ùå TruffleHog found potential secrets. Commit aborted."
    exit 1
else
    echo "‚úÖ TruffleHog found no issues. Proceeding with commit."
fi
