#!/bin/bash
set -euo pipefail

# Ensure staged YAML files end with a newline (fixes yamllint error)
mapfile -d '' YAML_STAGED <<<"$(git diff --cached --name-only --diff-filter=ACMR -z | grep -z -E '\.ya?ml$' || true)"

if [ "${#YAML_STAGED[@]}" -gt 0 ]; then
    echo "ðŸ§¹ Ensuring final newline on YAML files..."
    for f in "${YAML_STAGED[@]}"; do
        # Skip if file no longer exists (renamed/deleted during staging)
        [ -f "$f" ] || continue

        if ! tail -c 1 -- "$f" | grep -q "^$"; then
            echo "â†ª adding newline: $f"
            # Append a single newline at EOF
            sed -i '$a\' -- "$f"
            # Restage the fixed file
            git add -- "$f"
        fi
    done
fi

echo "âœ… TruffleHog found no issues. Proceeding with commit."
