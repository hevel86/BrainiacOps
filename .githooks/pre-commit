#!/bin/bash
set -euo pipefail

echo "üîç Running TruffleHog scan on staged changes..."

# Optional manual bypass
if [ "${SKIP_TRUFFLEHOG:-}" = "1" ]; then
    echo "‚ö†Ô∏è  SKIP_TRUFFLEHOG=1 ‚Üí skipping TruffleHog scan."
    exit 0
fi

# Identify staged YAML, ENV, or JSON files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.ya?ml$|\.env$|\.json$' || true)

# Skip if no relevant files staged
if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No staged YAML, ENV, or JSON files to scan."
    exit 0
fi

# Require Docker CLI
if ! command -v docker >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Docker CLI not found ‚Üí skipping TruffleHog scan."
    exit 0
fi

# Require Docker daemon
if ! docker info >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Docker daemon unavailable ‚Üí skipping TruffleHog scan."
    exit 0
fi

# Run TruffleHog only on staged changes using git diff piped to stdin
if ! git diff --cached | docker run --rm -i ghcr.io/trufflesecurity/trufflehog:latest \
    filesystem --path - --only-verified --no-update --fail; then
    echo "‚ùå TruffleHog found potential secrets. Commit aborted."
    exit 1
fi

echo "‚úÖ TruffleHog found no issues. Proceeding with commit."
